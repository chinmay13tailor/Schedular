<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PlantWiz – Training Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root{
      --bg:#ffffff; --muted:#f3f4f6; --text:#0f172a; --sub:#64748b; --ring:#e5e7eb;
      --blue:#3b82f6; --green:#22c55e; --cyan:#06b6d4; --amber:#f59e0b; --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{display:grid;grid-template-columns:1fr 320px;gap:16px;min-height:100vh;padding:16px}
    header{grid-column:1/-1;display:flex;gap:10px;align-items:center;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
    .brand{font-weight:800}
    .spacer{flex:1}
    .select,.btn,.input{border:1px solid var(--ring);background:#fff;border-radius:10px;padding:8px 10px}
    .btn{cursor:pointer}
    .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
    .side{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;position:sticky;top:16px;height:fit-content}
    .empty{padding:12px;text-align:center;color:#64748b;background:var(--muted);border-radius:10px}
    .h6{margin:0 0 10px;font-weight:900}
    .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
    .kpi span:first-child{color:#64748b}
    footer{grid-column:1/-1;color:#64748b;font-size:12px;text-align:center}
    @media(max-width:1024px){.app{grid-template-columns:1fr}.side{position:static}}

    /* FullCalendar tweaks */
    .fc .fc-toolbar{padding:10px}
    .fc .fc-toolbar-title{font-size:16px;font-weight:800}
    .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#fff;border-radius:10px;padding:6px 10px;color:#0f172a}
    .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
    .fc-daygrid-day-number{color:#64748b}

    /* Event chip */
    .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;
           box-shadow:0 1px 0 rgba(0,0,0,.08), 0 8px 16px -12px rgba(0,0,0,.25)}
    .status-planned{background:var(--blue)}
    .status-live{background:var(--green)}
    .status-completed{background:var(--cyan)}
    .status-cancelled{background:var(--red)}
    .status-pending_approval{background:var(--amber)}
    .sub{display:block;font-weight:600;opacity:.95}
    .tiny{display:block;font-weight:600;opacity:.8;font-size:12px}
    .badge{display:inline-block;border-radius:999px;padding:3px 8px;font-size:12px;color:#fff}
    .b-planned{background:var(--blue)}.b-live{background:var(--green)}.b-completed{background:var(--cyan)}
    .b-cancelled{background:var(--red)}.b-pending_approval{background:var(--amber)}
    .muted{color:#64748b}
    #loading{font-size:12px;color:#64748b;margin-left:8px}

    /* ===== Modal (Create Session) ===== */
    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(520px,92vw);background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:0 24px 48px rgba(0,0,0,.18)}
    .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
    .modal .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .modal .row-full{grid-column:1 / -1}
    .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}
    .danger{background:#fff;border:1px solid var(--red);color:#dc2626}
    .primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
    .debug{margin-top:14px;padding-top:12px;border-top:1px dashed var(--ring)}
    .ok{color:#16a34a;font-weight:700}
    .err{color:#dc2626;font-weight:700}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">PlantWiz • Training Calendar</div>
    <div class="spacer"></div>
    <select id="filterStatus" class="select">
      <option value="">All Status</option>
      <option>planned</option><option>live</option><option>completed</option>
      <option>cancelled</option><option value="pending_approval">pending_approval</option>
    </select>
    <select id="filterTrainer" class="select"><option value="">All Trainers</option></select>
    <select id="filterMachine" class="select"><option value="">All Machines</option></select>
    <button id="btnToday" class="btn">Today</button>
    <span id="loading"></span>
  </header>

  <div class="card"><div id="calendar"></div></div>

  <aside class="side">
    <h3 class="h6">Session details</h3>
    <div id="details" class="empty">Select a session on the calendar</div>

    <!-- Quick dump block -->
    <div class="debug">
      <h3 class="h6">Quick Dump: Training_Operator_Name</h3>
      <input id="dumpInput" class="input" type="text" placeholder="Type operator name…"/>
      <button id="dumpBtn" class="btn" style="margin-left:6px;">Dump</button>
      <div id="dumpStatus" class="muted" style="margin-top:6px;"></div>
    </div>
  </aside>

  <footer>Keys incl. creation mapping: Training_Title, Training_Operator_Name, Training_Start, Training_End, Trainer_Name, Training_Topic, Training_Machine, Training_Status</footer>
</div>

<!-- ===== Create Session Modal ===== -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900">Add training session</div>
      <button class="btn danger" id="closeModal">Cancel</button>
    </header>
    <div class="body">
      <div class="row-full">
        <label>Title</label>
        <input id="fTitle" class="input" type="text" placeholder="e.g., Operational Safety"/>
      </div>
      <div>
        <label>Operator</label>
        <input id="fOperator" class="input" type="text" placeholder="Operator name"/>
      </div>
      <div>
        <label>Trainer Name</label>
        <input id="fTrainer" class="input" type="text" placeholder="Trainer name"/>
      </div>
      <div>
        <label>Time To</label>
        <input id="fTimeTo" class="input" type="time" value="09:00"/>
      </div>
      <div>
        <label>Time From</label>
        <input id="fTimeFrom" class="input" type="time" value="11:00"/>
      </div>
      <div class="row-full">
        <label>Training Topic</label>
        <input id="fTopic" class="input" type="text" placeholder="Short description"/>
      </div>
      <div class="row-full">
        <label>Training Machine</label>
        <input id="fMachine" class="input" type="text" placeholder="e.g., LATHE-02"/>
      </div>
      <div class="row-full muted" id="fDateHint">Date: —</div>
    </div>
    <footer>
      <button class="btn primary" id="saveSession">Save</button>
    </footer>
  </div>
</div>

<script>
/* =======================
   0) CONFIG (YOUR ENV)
   ======================= */
const API_BASE   = "https://plantwiz.pimateck.in/api";
const DEVICE_ID  = "991cf500-661a-11f0-90f1-775fee303094";
const QS         = new URLSearchParams(location.search);
const TOKEN      = QS.get("token")  || ""; // JWT (passed by TB HTML widget)
const DTOKEN     = QS.get("dtoken") || ""; // optional device access token fallback

// Keys (includes Training_Title). We also accept both spellings for "Score".
const TRAINING_KEYS = [
  "Training_Title",
  "Training_Operator_Name",
  "Trainer_Name",
  "Training_Status",
  "Training_Start",
  "Training_End",
  "Training_Scrore_Obtained",
  "Training_Score_Obtained",
  "Training_Topic",
  "Training_Machine"
];

// UI state
const state = { events: [], calendar: null, lastRange: null, clickedDate: null };

/* =======================
   HELPERS
   ======================= */
const $ = sel => document.querySelector(sel);
const loading = (txt) => $("#loading").textContent = txt || "";
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function colorByStatus(s){
  switch(String(s || "").toLowerCase()){
    case "planned": return "status-planned"; case "live": return "status-live";
    case "completed": return "status-completed"; case "cancelled": return "status-cancelled";
    case "pending_approval": return "status-pending_approval"; default: return "status-planned";
  }
}
// Parse epoch ms / epoch sec / ISO / "YYYY-MM-DD HH:mm"
function parseMaybeTs(v){
  if (v == null) return null;
  const s = String(v).trim();
  if (/^\d+$/.test(s)) { const n=Number(s); return n<1e12 ? n*1000 : n; }
  const m = s.match(/^(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2})(:\d{2})?$/);
  if (m){ const iso=`${m[1]}T${m[2]}${m[3]||''}+05:30`; const t=Date.parse(iso); return Number.isFinite(t)?t:null; }
  const t = Date.parse(s); return Number.isFinite(t)?t:null;
}
function eventContent(arg){
  const p = arg.event.extendedProps;
  const time = arg.timeText || "";
  const machine = p.Training_Machine ? ` • ${escapeHtml(p.Training_Machine)}` : "";
  const trainer = p.Trainer_Name ? ` – ${escapeHtml(p.Trainer_Name)}` : "";
  const title = arg.event.title || "Training";
  return { html: `
    <span class="sub">${time}${machine}</span>
    <span>${escapeHtml(title)}${trainer}</span>
    <span class="tiny">${escapeHtml(p.Training_Operator_Name || "")}</span>
  `};
}

/* =======================
   COMMON WRITE (robust)
   ======================= */
async function writeTelemetry(payload){
  if(!TOKEN){ throw new Error("Missing JWT (?token=)"); }
  // Attempt 1: JWT timeseries (no trailing slash)
  const url1 = `${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/timeseries`;
  let res = await fetch(url1, {
    method: "POST",
    headers: { "X-Authorization": `Bearer ${TOKEN}`, "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if(res.ok) return;

  const text1 = await res.text().catch(()=>res.statusText||"");
  const looksLikeAttrScope = /AttributeScope/i.test(text1);

  if (looksLikeAttrScope) {
    // Attempt 2: add trailing slash
    const url2 = `${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/timeseries/`;
    res = await fetch(url2, {
      method: "POST",
      headers: { "X-Authorization": `Bearer ${TOKEN}`, "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if(res.ok) return;

    const text2 = await res.text().catch(()=>res.statusText||"");
    // Attempt 3: device HTTP telemetry (needs ?dtoken=...)
    if (DTOKEN) {
      const origin = new URL(API_BASE).origin;
      const url3 = `${origin}/api/v1/${DTOKEN}/telemetry`;
      res = await fetch(url3, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if(res.ok) return;
      const text3 = await res.text().catch(()=>res.statusText||"");
      throw new Error(`Save failed (all attempts).
1) ${url1}: ${text1}
2) ${url2}: ${text2}
3) ${url3}: ${text3}`);
    } else {
      throw new Error(`Save failed.
${url1}: ${text1}
${url2}: ${text2}
Tip: pass ?dtoken=<DEVICE_ACCESS_TOKEN> to use the device telemetry endpoint as a fallback.`);
    }
  } else {
    // Not AttributeScope, but still failed → try trailing slash once
    const url2 = `${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/timeseries/`;
    const res2 = await fetch(url2, {
      method: "POST",
      headers: { "X-Authorization": `Bearer ${TOKEN}`, "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (res2.ok) return;
    const text2 = await res2.text().catch(()=>res2.statusText||"");
    throw new Error(`Save failed.
${url1}: ${text1}
${url2}: ${text2}`);
  }
}

/* =======================
   FETCH (ThingsBoard)
   ======================= */
async function fetchSessions(startMs, endMs){
  if(!TOKEN){ throw new Error("Missing JWT: pass ?token=YOUR_JWT in URL"); }
  const keysParam = encodeURIComponent(TRAINING_KEYS.join(','));
  const url = `${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${keysParam}&startTs=${startMs}&endTs=${endMs}&limit=10000&agg=NONE&order=ASC`;
  const res = await fetch(url, { headers: { "X-Authorization": `Bearer ${TOKEN}` }});
  if(!res.ok){ const msg = await res.text().catch(()=>res.statusText); throw new Error(`TB fetch failed: ${res.status} ${msg}`); }
  const json = await res.json();

  // Build rows by ts
  const byTs = new Map();
  for (const [key, arr] of Object.entries(json || {})) {
    (arr || []).forEach(p => {
      const ts = Number(p.ts); if(!Number.isFinite(ts)) return;
      const r = byTs.get(ts) || { __ts: ts };
      r[key] = p.value;
      byTs.set(ts, r);
    });
  }

  // Merge into session objects keyed by Operator|Machine|Topic|Title
  const acc = new Map();
  const idFor = (o,m,t,ttl)=>[o||'',m||'',t||'',ttl||''].join('|');
  [...byTs.values()].sort((a,b)=>a.__ts-b.__ts).forEach(r=>{
    r.Training_Score_Obtained = r.Training_Score_Obtained ?? r.Training_Scrore_Obtained ?? null;
    const o=(r.Training_Operator_Name||'').trim(); const m=(r.Training_Machine||'').trim();
    const t=(r.Training_Topic||'').trim(); const ttl=(r.Training_Title||'').trim();
    const id=idFor(o,m,t,ttl)||'__unknown__';
    const obj=acc.get(id) || { Operator:o, Machine:m, Topic:t, Title:ttl, Trainer:null, Status:null, Start:null, End:null, Score:null, _ts:0 };
    if (r.Trainer_Name) obj.Trainer=r.Trainer_Name;
    if (r.Training_Status) obj.Status=r.Training_Status;
    if (r.Training_Start){ const ts=parseMaybeTs(r.Training_Start); if(ts) obj.Start=ts; }
    if (r.Training_End){ const te=parseMaybeTs(r.Training_End); if(te) obj.End=te; }
    if (r.Training_Score_Obtained!=null && r.Training_Score_Obtained!=='') obj.Score=r.Training_Score_Obtained;
    obj._ts=r.__ts; acc.set(id,obj);
  });

  // To events
  const events=[];
  acc.forEach(o=>{
    if(!o.Start || !o.End) return;
    events.push({
      id: `${o.Operator}|${o.Machine}|${o.Topic}|${o.Title}|${o.Start}|${o.End}`,
      title: o.Title || o.Topic || "Training",
      start: new Date(o.Start),
      end:   new Date(o.End),
      classNames: ["event", colorByStatus(o.Status||'planned')],
      extendedProps: {
        Training_Title: o.Title,
        Training_Operator_Name: o.Operator,
        Trainer_Name: o.Trainer,
        Training_Status: o.Status,
        Training_Start: o.Start,
        Training_End: o.End,
        Training_Score_Obtained: o.Score,
        Training_Topic: o.Topic,
        Training_Machine: o.Machine
      }
    });
  });
  return events;
}

/* =======================
   FILTERS / DETAILS
   ======================= */
function fillSelectors(events){
  const uniq = a => [...new Set(a.filter(Boolean))].sort((x,y)=>String(x).localeCompare(String(y)));
  const trainers = uniq(events.map(e => e.extendedProps.Trainer_Name));
  const machines = uniq(events.map(e => e.extendedProps.Training_Machine));
  const fT = $("#filterTrainer"); const fM = $("#filterMachine");
  fT.innerHTML = '<option value="">All Trainers</option>';
  fM.innerHTML = '<option value="">All Machines</option>';
  trainers.forEach(t => fT.insertAdjacentHTML('beforeend', `<option>${escapeHtml(t)}</option>`));
  machines.forEach(m => fM.insertAdjacentHTML('beforeend', `<option>${escapeHtml(m)}</option>`));
}
function applyFilters(){
  const s = $("#filterStatus").value.trim();
  const t = $("#filterTrainer").value.trim();
  const m = $("#filterMachine").value.trim();
  const filtered = state.events.filter(ev => {
    const p = ev.extendedProps;
    return (!s || String(p.Training_Status||'').toLowerCase()===s.toLowerCase())
        && (!t || p.Trainer_Name===t)
        && (!m || p.Training_Machine===m);
  });
  state.calendar.removeAllEvents();
  state.calendar.addEventSource(filtered);
  $("#details").className="empty"; $("#details").textContent="Select a session on the calendar";
}
function showDetails(ev){
  const p = ev.extendedProps;
  const fmt = (v)=> v ? new Date(Number(v)).toLocaleString() : "-";
  const score = (p.Training_Score_Obtained == null || p.Training_Score_Obtained === "") ? "—" : p.Training_Score_Obtained;
  const badge = `badge b-${String(p.Training_Status||'planned').replace(' ','_')}`;
  $("#details").className = "";
  $("#details").innerHTML = `
    <div class="kpi">
      <span>Status</span><span><span class="${badge}">${escapeHtml(p.Training_Status||'planned')}</span></span>
      <span>Title</span><span>${escapeHtml(p.Training_Title||'-')}</span>
      <span>Topic</span><span>${escapeHtml(p.Training_Topic||'-')}</span>
      <span>Operator</span><span>${escapeHtml(p.Training_Operator_Name||'-')}</span>
      <span>Trainer</span><span>${escapeHtml(p.Trainer_Name||'-')}</span>
      <span>Machine</span><span>${escapeHtml(p.Training_Machine||'-')}</span>
      <span>Start</span><span>${fmt(p.Training_Start)}</span>
      <span>End</span><span>${fmt(p.Training_End)}</span>
      <span>Score</span><span>${escapeHtml(score)}</span>
    </div>`;
}

/* =======================
   QUICK DUMP (operator only)
   ======================= */
$("#dumpBtn").addEventListener("click", async () => {
  const name = ($("#dumpInput").value || "").trim();
  const out = $("#dumpStatus");
  if(!name){ out.innerHTML = '<span class="err">Enter a name to dump.</span>'; return; }
  out.textContent = 'Writing…';

  try{
    await writeTelemetry({ "Training_Operator_Name": name });
    out.innerHTML = `<span class="ok">Dumped</span> Training_Operator_Name = <b>${escapeHtml(name)}</b> @ ${new Date().toLocaleTimeString()}`;
  }catch(e){
    console.error(e);
    out.innerHTML = `<span class="err">Failed:</span> ${escapeHtml(e.message||String(e))}`;
  }
});

/* =======================
   CREATE SESSION (Modal)
   ======================= */
const overlay = $("#overlay");
$("#closeModal").addEventListener("click", () => overlay.style.display = "none");
$("#saveSession").addEventListener("click", saveSession);

function openModalForDate(jsDate){
  state.clickedDate = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate()); // strip time
  $("#fDateHint").textContent = "Date: " + state.clickedDate.toDateString();
  // sensible defaults
  $("#fTitle").value = ""; $("#fOperator").value = ""; $("#fTrainer").value = "";
  $("#fTopic").value = ""; $("#fMachine").value = "";
  $("#fTimeTo").value = "09:00"; $("#fTimeFrom").value = "11:00";
  overlay.style.display = "flex";
}
function mergeDateTime(baseDate, hhmm){
  const [h,m] = String(hhmm||"00:00").split(":").map(n=>parseInt(n||"0",10));
  const d = new Date(baseDate);
  d.setHours(h||0, m||0, 0, 0);
  return d.getTime(); // epoch ms
}

/* ==== SAVE full session ==== */
async function saveSession(){
  try{
    const base = state.clickedDate || new Date();
    // Mapping as requested (Time To -> Start, Time From -> End)
    const payload = {
      Training_Title: $("#fTitle").value.trim(),
      Training_Operator_Name: $("#fOperator").value.trim(),
      Training_Start: mergeDateTime(base, $("#fTimeTo").value),
      Training_End:   mergeDateTime(base, $("#fTimeFrom").value),
      Trainer_Name: $("#fTrainer").value.trim(),
      Training_Topic: $("#fTopic").value.trim(),
      Training_Machine: $("#fMachine").value.trim(),
      Training_Status: "planned"
    };

    // basic validation
    const req = [
      ['Title', payload.Training_Title],
      ['Operator', payload.Training_Operator_Name],
      ['Trainer Name', payload.Trainer_Name],
      ['Training Topic', payload.Training_Topic],
      ['Training Machine', payload.Training_Machine]
    ];
    for (const [label,val] of req){ if(!val){ alert(`Please enter ${label}`); return; } }

    loading("Saving…");

    await writeTelemetry(payload);

    overlay.style.display = "none";
    loading("Saved. Refreshing…");
    if (state.lastRange){
      state.events = await fetchSessions(state.lastRange.start.getTime(), state.lastRange.end.getTime()-1);
      fillSelectors(state.events);
      applyFilters();
      loading(`Loaded ${state.events.length} session(s)`);
    } else {
      state.calendar.refetchEvents?.();
      loading("");
    }
  }catch(e){
    console.error(e);
    alert(e.message || "Failed to save session");
    loading("");
  }
}

/* =======================
   BOOT
   ======================= */
document.addEventListener("DOMContentLoaded", () => {
  const calEl = $("#calendar");
  state.calendar = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    headerToolbar: { left: "prev,next", center: "title", right: "" },
    height: "auto",
    events: [],
    eventContent,
    eventClick: (info) => showDetails(info.event),
    dateClick: (info) => openModalForDate(info.date),
    datesSet: async (info) => {
      try{
        loading("Loading…");
        const {start,end} = info; state.lastRange = {start,end};
        state.events = await fetchSessions(start.getTime(), end.getTime()-1);
        fillSelectors(state.events);
        applyFilters();
        loading(`Loaded ${state.events.length} session(s)`);
      }catch(err){
        console.error(err);
        loading(err.message || "Failed to load");
        state.calendar.removeAllEvents();
      }
    }
  });
  state.calendar.render();

  $("#btnToday").addEventListener("click", () => state.calendar.today());
  ["filterStatus","filterTrainer","filterMachine"].forEach(id =>
    document.getElementById(id).addEventListener("change", applyFilters)
  );
});
</script>
</body>
</html>
