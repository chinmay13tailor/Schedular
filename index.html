<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PlantWiz • Training Calendar</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--cyan:#06b6d4;--red:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-columns:1fr 320px;gap:16px;min-height:100vh;padding:16px}
  header{grid-column:1/-1;display:flex;gap:10px;align-items:center;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
  .brand{font-weight:800}.spacer{flex:1}
  .btn,.input,textarea{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .btn.danger{border-color:var(--red);color:#dc2626}
  .btn.ghost{border-color:var(--ring);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #calendar{min-height:560px}
  .side{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;position:sticky;top:16px;height:fit-content}
  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  .side-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  footer{grid-column:1/-1;color:#64748b;font-size:12px;text-align:center}

  .fc .fc-toolbar{padding:10px}
  .fc .fc-toolbar-title{font-size:16px;font-weight:800}
  .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#0f172a;border-radius:10px;padding:6px 10px}
  .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
  .fc-daygrid-day-number{color:#64748b}

  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)}
  .status-compleated{background:var(--cyan)}
  .status-cancelled{background:var(--red)}
  .sub{display:block;font-weight:600;opacity:.95}
  .tiny{display:block;font-weight:600;opacity:.8;font-size:12px}

  .muted{color:#64748b} #loading{font-size:12px;color:#64748b;margin-left:8px}
  .success{color:#16a34a}.err{color:#dc2626;font-weight:700}

  /* Modal base */
  .overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(560px,92vw);background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:0 24px 48px rgba(0,0,0,.18)}
  .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
  .modal .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal .row-full{grid-column:1 / -1}
  .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}

  /* Chips (reused for operator & mail) */
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px;background:#f8fafc}
  .chip button{border:0;background:transparent;cursor:pointer;font-weight:900;line-height:1}
  .row-flex{display:flex;gap:8px;align-items:center}
  .row-flex .input{flex:1}

  /* Mail modal extras */
  .mail-details{border:1px dashed var(--ring);border-radius:10px;padding:10px;font-size:13px}
  .chips-hint{font-size:12px;color:#64748b}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">PlantWiz • Training Calendar</div>
    <span class="muted">Create → <code>Save_Button=false</code>. Update/Cancel → <code>Update_Buttton=true</code> + <code>Update_Timestamp</code>. “Send Mail” writes <code>Send_Mail=true</code> only.</span>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <div class="card"><div id="calendar"></div></div>

  <aside class="side">
    <h3 class="h6">Session details</h3>
    <div id="details" class="empty">Select a session on the calendar</div>
    <div class="side-actions" id="sideActions" style="display:none">
      <button class="btn danger"  id="btnCancel" type="button">Cancel training</button>
      <button class="btn ghost"   id="btnEdit"   type="button">Update</button>
      <button class="btn primary" id="btnMail"   type="button">Send Mail</button>
    </div>
  </aside>

  <footer>
    Calendar reads telemetry; rule-chain mirrors attributes to telemetry & can rewrite rows using <code>Update_Timestamp</code>.
  </footer>
</div>

<!-- Create/Update Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900" id="modalTitle">Add training session</div>
      <button class="btn" id="closeModal" type="button">Close</button>
    </header>
    <div class="body">
      <div class="row-full">
        <label>Title</label>
        <input id="fTitle" class="input" type="text" placeholder="e.g., Operational Safety">
      </div>

      <!-- MULTI-OPERATOR UI -->
      <div class="row-full">
        <label>Operators</label>
        <div class="row-flex">
          <input id="fOperatorInput" class="input" type="text" placeholder="Type a name and click +">
          <button class="btn ghost" id="addOperatorBtn" type="button">+</button>
        </div>
        <div id="opChips" class="chips"></div>
        <div class="chips-hint">Add one operator at a time using “+”.</div>
      </div>
      <!-- /MULTI-OPERATOR -->

      <div>
        <label>Trainer Name</label>
        <input id="fTrainer" class="input" type="text" placeholder="Trainer name">
      </div>
      <div>
        <label>Time To</label>
        <input id="fTimeTo" class="input" type="time" value="09:00">
      </div>
      <div>
        <label>Time From</label>
        <input id="fTimeFrom" class="input" type="time" value="11:00">
      </div>
      <div class="row-full">
        <label>Training Topic</label>
        <input id="fTopic" class="input" type="text" placeholder="Short description">
      </div>
      <div class="row-full">
        <label>Training Machine</label>
        <input id="fMachine" class="input" type="text" placeholder="e.g., LATHE-02">
      </div>

      <div class="row-full">
        <label>Training Status</label>
        <select id="fStatus" class="input">
          <option value="Planned">Planned</option>
          <option value="Compleated">Compleated</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <div class="muted" style="margin-top:6px">Pick <strong>Planned</strong> to reactivate a cancelled session.</div>
      </div>

      <div class="row-full muted" id="fDateHint">Date: —</div>
    </div>
    <footer>
      <button class="btn primary" id="saveSession" type="button">Save</button>
    </footer>
  </div>
</div>

<!-- Send Mail Modal -->
<div class="overlay" id="mailOverlay">
  <div class="modal">
    <header>
      <div style="font-weight:900">Send Training Details by Email</div>
      <button class="btn" id="closeMailModal" type="button">Close</button>
    </header>
    <div class="body">
      <div class="row-full">
        <div class="mail-details" id="mailDetailsBox"></div>
      </div>

      <div class="row-full">
        <label>Recipient emails</label>
        <div class="row-flex">
          <input id="mailOne" class="input" type="email" placeholder="name@company.com">
          <button class="btn ghost" id="addMailBtn" type="button">+</button>
        </div>
        <div id="mailChips" class="chips"></div>
        <div class="chips-hint">Add one email at a time using “+”. Example: ops@plant.com, trainer@plant.com</div>
      </div>
    </div>
    <footer>
      <button class="btn primary" id="sendMailBtn" type="button">Send</button>
    </footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
/************ CONFIG ************/
var ORIGIN    = "https://plantwiz.pimateck.in";
var API_BASE  = ORIGIN + "/api";
var DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
var JWT       = new URLSearchParams(location.search).get("token")  || "";

// Flags (used by rule-chain, not shown in UI)
var ATTR_SAVE_FLAG    = "Save_Button";       // only on CREATE
var ATTR_UPDATE_FLAG  = "Update_Buttton";    // exact spelling, on UPDATE/CANCEL
var ATTR_SEND_MAIL    = "Send_Mail";         // for mail trigger
var ATTR_TRAINING_MAILS = "Training_mails";  // list of recipients

// Telemetry keys we read
var KEYS = [
  "Training_Title","Training_Operator_Name","Training_Start","Training_End",
  "Trainer_Name","Training_Topic","Training_Machine","Training_Status"
];

/************ HELPERS ************/
function $(s){ return document.querySelector(s); }
function loading(t){ $("#loading").textContent = t || ""; }
var state = {
  calendar:null, clickedDate:null, lastRange:null, selectedEvent:null, mode:"create",
  mailList: [],     // email chips
  opList: []        // operator chips
};

function mergeDateTime(baseDate, hhmm){
  var parts = String(hhmm||"00:00").split(":");
  var h = parseInt(parts[0]||"0",10), m = parseInt(parts[1]||"0",10);
  var d = new Date(baseDate); d.setHours(h||0, m||0, 0, 0);
  return d.getTime();
}
function msToHHMM(ms){
  var d = new Date(ms);
  return String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0');
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function colorByStatus(s){
  var v = String(s||"Planned").toLowerCase();
  if (v==="cancelled") return "status-cancelled";
  if (v==="compleated") return "status-compleated";
  return "status-planned";
}
function eventContent(arg){
  var p = arg.event.extendedProps;
  var time = arg.timeText || "";
  var machine = p.Training_Machine ? (" • " + escapeHtml(p.Training_Machine)) : "";
  var trainer = p.Trainer_Name ? (" – " + escapeHtml(p.Trainer_Name)) : "";
  var title = arg.event.title || "Training";
  return { html:
    '<span class="sub">'+time+machine+'</span>'+
    '<span>'+escapeHtml(title)+trainer+'</span>'+
    '<span class="tiny">'+escapeHtml(p.Training_Operator_Name || "")+'</span>'
  };
}
function isValidEmail(s){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/i.test(s || "");
}

/************ READ (telemetry) ************/
function readRangeSessions(rangeStart, rangeEnd){
  if(!JWT){ return Promise.reject(new Error("Missing JWT (?token=)")); }
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries"
          + "?keys=" + encodeURIComponent(KEYS.join(",")) +
            "&startTs=" + rangeStart.getTime() +
            "&endTs="   + rangeEnd.getTime() +
            "&limit=5000";
  return fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } })
    .then(res => res.ok ? res.json() : res.text().then(t => { throw new Error("Timeseries read failed: "+t); }))
    .then(tsObj => {
      var map = {};
      Object.keys(tsObj || {}).forEach(k => {
        (tsObj[k]||[]).forEach(p => {
          var ts = Number(p.ts);
          var rec = map[ts] || (map[ts] = { ts: ts });
          rec[k] = p.value;
        });
      });
      var out = [];
      Object.keys(map).forEach(tsStr => {
        var r = map[tsStr];
        var st = Number(r.Training_Start || r.ts);
        var en = Number(r.Training_End || (st+30*60*1000));
        if (!st || !en) return;
        var title = String(r.Training_Title || r.Training_Topic || "Training");
        out.push({
          id: "ts-"+r.ts,
          title: title,
          start: new Date(st),
          end:   new Date(en),
          classNames: ["event", colorByStatus(r.Training_Status)],
          extendedProps: {
            Training_Title: title,
            Training_Operator_Name: r.Training_Operator_Name || "",
            Training_Start: st,
            Training_End: en,
            Trainer_Name: r.Trainer_Name || "",
            Training_Topic: r.Training_Topic || "",
            Training_Machine: r.Training_Machine || "",
            Training_Status: r.Training_Status || "Planned",
            __ts: r.ts
          }
        });
      });
      out.sort((a,b)=>a.start-b.start);
      return out;
    });
}

/************ AUTO-REFRESH LOOP (every 5s, up to 3 min) ************/
var _autoTimer = null, _autoDeadline = 0;
function stopAutoRefresh(){ if (_autoTimer) { clearInterval(_autoTimer); _autoTimer = null; } }
function startAutoRefresh(expectedTs, predicate){
  stopAutoRefresh();
  _autoDeadline = Date.now() + 3*60*1000;
  _autoTimer = setInterval(function(){
    if (Date.now() > _autoDeadline) {
      stopAutoRefresh();
      loading("Stopped: timeout waiting for telemetry update");
      return;
    }
    if (!state.lastRange) return;
    readRangeSessions(state.lastRange.start, state.lastRange.end)
      .then(function(events){
        state.calendar.removeAllEvents();
        state.calendar.addEventSource(events);
        $("#details").className="empty"; $("#details").textContent="Select a session on the calendar";
        $("#sideActions").style.display="none";
        loading("Auto-refreshing…");
        if (expectedTs != null){
          var found = events.find(ev => String(ev.extendedProps.__ts) === String(expectedTs));
          if (found){
            if (typeof predicate === "function") {
              try { if (predicate(found)) { stopAutoRefresh(); loading("Update detected ✓"); } }
              catch(e){}
            } else { stopAutoRefresh(); loading("Update detected ✓"); }
          }
        } else {
          stopAutoRefresh();
        }
      })
      .catch(function(err){
        console.error(err);
        loading("Auto-refresh error: "+(err.message||err));
      });
  }, 5000);
}

/************ WRITE (attributes) ************/
function writeAttributes(session, opts){
  if(!JWT) return Promise.reject(new Error("Missing JWT (?token=)"));
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/SERVER_SCOPE";

  var body = {
    Training_Title:         session.Training_Title,
    Training_Operator_Name: session.Training_Operator_Name,
    Training_Start:         session.Training_Start,
    Training_End:           session.Training_End,
    Trainer_Name:           session.Trainer_Name,
    Training_Topic:         session.Training_Topic,
    Training_Machine:       session.Training_Machine,
    Training_Status:        session.Training_Status || "Planned"
  };

  if (opts && opts.mode === "create") {
    body[ATTR_SAVE_FLAG] = false;
  } else if (opts && (opts.mode === "update" || opts.mode === "cancel")) {
    body[ATTR_UPDATE_FLAG] = true;
    if (session.Update_Timestamp) body.Update_Timestamp = session.Update_Timestamp;
  }

  return fetch(url, {
    method: "POST",
    headers: { "X-Authorization": "Bearer " + JWT, "Content-Type": "application/json" },
    body: JSON.stringify(body)
  }).then(res => res.ok ? null : res.text().then(t => { throw new Error("Attribute write failed: "+t); }));
}

/* WRITE (mail trigger): ONLY Send_Mail + Training_mails + training fields (NO Save/Update flags) */
function writeMailAttributes(session, recipients){
  if(!JWT) return Promise.reject(new Error("Missing JWT (?token=)"));
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/SERVER_SCOPE";

  var body = {
    Training_Title:         session.Training_Title || "",
    Training_Operator_Name: session.Training_Operator_Name || "",
    Training_Start:         session.Training_Start,
    Training_End:           session.Training_End,
    Trainer_Name:           session.Trainer_Name || "",
    Training_Topic:         session.Training_Topic || "",
    Training_Machine:       session.Training_Machine || "",
    Training_Status:        session.Training_Status || "Planned",
    [ATTR_SEND_MAIL]:       true,
    [ATTR_TRAINING_MAILS]:  recipients
  };
  return fetch(url, {
    method: "POST",
    headers: { "X-Authorization": "Bearer " + JWT, "Content-Type": "application/json" },
    body: JSON.stringify(body)
  }).then(res => res.ok ? null : res.text().then(t => { throw new Error("Mail attribute write failed: "+t); }));
}

/************ DETAILS + ACTION BUTTONS ************/
function showDetails(ev){
  state.selectedEvent = ev;
  var p = ev.extendedProps;
  function fmt(v){ return v ? new Date(Number(v)).toLocaleString() : "-"; }
  var badgeCls = colorByStatus(p.Training_Status);
  $("#details").className = "";
  $("#details").innerHTML =
    '<div class="kpi">'+
      '<span>Base ts</span><span>'+escapeHtml(String(p.__ts||"-"))+'</span>'+
      '<span>Status</span><span><span class="'+badgeCls+'" style="padding:2px 8px;border-radius:999px;color:#fff;">'+escapeHtml(p.Training_Status||"Planned")+'</span></span>'+
      '<span>Title</span><span>'+escapeHtml(p.Training_Title||"-")+'</span>'+
      '<span>Topic</span><span>'+escapeHtml(p.Training_Topic||"-")+'</span>'+
      '<span>Operator(s)</span><span>'+escapeHtml(p.Training_Operator_Name||"-")+'</span>'+
      '<span>Trainer</span><span>'+escapeHtml(p.Trainer_Name||"-")+'</span>'+
      '<span>Machine</span><span>'+escapeHtml(p.Training_Machine||"-")+'</span>'+
      '<span>Start</span><span>'+fmt(p.Training_Start)+'</span>'+
      '<span>End</span><span>'+fmt(p.Training_End)+'</span>'+
    '</div>';

  $("#sideActions").style.display = "flex";
}

/************ OPERATOR CHIPS UI ************/
function refreshOpChips(){
  var box = $("#opChips");
  box.innerHTML = "";
  state.opList.forEach(function(name, idx){
    var chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = '<span>'+escapeHtml(name)+'</span><button type="button" aria-label="Remove">✕</button>';
    chip.querySelector("button").addEventListener("click", function(){
      state.opList.splice(idx, 1);
      refreshOpChips();
    });
    box.appendChild(chip);
  });
}
function addOneOperatorFromInput(){
  var val = ($("#fOperatorInput").value || "").trim();
  if (!val) return;
  if (state.opList.includes(val)) { alert("Already added: "+val); return; }
  state.opList.push(val);
  $("#fOperatorInput").value = "";
  refreshOpChips();
}
$("#addOperatorBtn").addEventListener("click", addOneOperatorFromInput);
$("#fOperatorInput").addEventListener("keydown", function(e){
  if (e.key === "Enter"){ e.preventDefault(); addOneOperatorFromInput(); }
});

/************ MAIL CHIPS UI ************/
var mailOverlay = $("#mailOverlay");
function refreshMailChips(){
  var box = $("#mailChips");
  box.innerHTML = "";
  state.mailList.forEach(function(email, idx){
    var chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = '<span>'+escapeHtml(email)+'</span><button type="button" aria-label="Remove">✕</button>';
    chip.querySelector("button").addEventListener("click", function(){
      state.mailList.splice(idx, 1);
      refreshMailChips();
    });
    box.appendChild(chip);
  });
}
function addOneEmailFromInput(){
  var val = ($("#mailOne").value || "").trim();
  if (!val) return;
  var email = val.toLowerCase();
  if (!isValidEmail(email)) { alert("Invalid email: "+val); return; }
  if (state.mailList.includes(email)) { alert("Already added: "+email); return; }
  state.mailList.push(email);
  $("#mailOne").value = "";
  refreshMailChips();
}
$("#addMailBtn").addEventListener("click", addOneEmailFromInput);
$("#mailOne").addEventListener("keydown", function(e){
  if (e.key === "Enter"){ e.preventDefault(); addOneEmailFromInput(); }
});

/************ MODALS + ACTIONS ************/
var overlay = $("#overlay");
function busy(on){
  $("#saveSession").disabled = !!on;
  $("#btnCancel").disabled   = !!on;
  $("#btnEdit").disabled     = !!on;
  $("#btnMail").disabled     = !!on;
  $("#sendMailBtn").disabled = !!on;
  $("#addMailBtn").disabled  = !!on && $("#addMailBtn");
  $("#addOperatorBtn").disabled = !!on && $("#addOperatorBtn");
}
$("#closeModal").addEventListener("click", function(){ overlay.style.display = "none"; });
$("#closeMailModal").addEventListener("click", function(){ mailOverlay.style.display = "none"; });

$("#saveSession").addEventListener("click", function(){
  if (state.mode === "update") onUpdateSession();
  else onCreateSession();
});

$("#btnEdit").addEventListener("click", function(){
  if (!state.selectedEvent) { alert("Select a session first."); return; }
  var p = state.selectedEvent.extendedProps;
  state.mode = "update";
  $("#modalTitle").textContent = "Update training session";
  $("#saveSession").textContent = "Update";

  var base = new Date(p.Training_Start);
  state.clickedDate = new Date(base.getFullYear(), base.getMonth(), base.getDate());

  // Prefill operator chips from existing comma-separated string
  var opStr = p.Training_Operator_Name || "";
  state.opList = opStr ? opStr.split(",").map(s=>s.trim()).filter(Boolean) : [];
  refreshOpChips();

  $("#fTrainer").value  = p.Trainer_Name || "";
  $("#fTopic").value    = p.Training_Topic || "";
  $("#fMachine").value  = p.Training_Machine || "";
  $("#fTimeTo").value   = msToHHMM(p.Training_Start);
  $("#fTimeFrom").value = msToHHMM(p.Training_End);
  $("#fStatus").value   = p.Training_Status || "Planned";
  $("#fTitle").value    = p.Training_Title || "";
  $("#fOperatorInput").value = "";
  $("#fDateHint").textContent = "Date: " + state.clickedDate.toDateString();

  overlay.style.display = "flex";
});

$("#btnCancel").addEventListener("click", function(){
  if (!state.selectedEvent) { alert("Select a session first."); return; }
  if (!confirm("Cancel this training?")) return;

  var p = state.selectedEvent.extendedProps;
  var payload = {
    Training_Title: p.Training_Title || "",
    Training_Operator_Name: p.Training_Operator_Name || "",
    Training_Start: p.Training_Start,
    Training_End:   p.Training_End,
    Trainer_Name: p.Trainer_Name || "",
    Training_Topic: p.Training_Topic || "",
    Training_Machine: p.Training_Machine || "",
    Training_Status: "Cancelled",
    Update_Timestamp: p.__ts
  };

  loading("Cancelling…"); busy(true);
  writeAttributes(payload, { mode: "cancel" })
    .then(function(){
      startAutoRefresh(payload.Update_Timestamp, function(found){
        return String(found.extendedProps.Training_Status).toLowerCase() === "cancelled";
      });
    })
    .catch(err => { console.error(err); alert(err.message||"Failed to cancel"); })
    .finally(()=>{ busy(false); });
});

/* Open mail modal */
$("#btnMail").addEventListener("click", function(){
  if (!state.selectedEvent) { alert("Select a session first."); return; }
  var p = state.selectedEvent.extendedProps;
  var fmt = v => v ? new Date(Number(v)).toLocaleString() : "-";
  var html =
    '<div><strong>Title:</strong> '   + escapeHtml(p.Training_Title||"-") + '</div>'+
    '<div><strong>Operator(s):</strong> '+ escapeHtml(p.Training_Operator_Name||"-") + '</div>'+
    '<div><strong>Trainer:</strong> ' + escapeHtml(p.Trainer_Name||"-") + '</div>'+
    '<div><strong>Topic:</strong> '   + escapeHtml(p.Training_Topic||"-") + '</div>'+
    '<div><strong>Machine:</strong> ' + escapeHtml(p.Training_Machine||"-") + '</div>'+
    '<div><strong>Status:</strong> '  + escapeHtml(p.Training_Status||"Planned") + '</div>'+
    '<div><strong>Start:</strong> '   + fmt(p.Training_Start) + '</div>'+
    '<div><strong>End:</strong> '     + fmt(p.Training_End) + '</div>';
  $("#mailDetailsBox").innerHTML = html;

  state.mailList = [];
  refreshMailChips();
  $("#mailOne").value = "";
  mailOverlay.style.display = "flex";
});

/* Send Mail → write attributes with Send_Mail=true & Training_mails */
$("#sendMailBtn").addEventListener("click", function(){
  if (!state.selectedEvent) { alert("Select a session first."); return; }
  if (state.mailList.length === 0){
    if (($("#mailOne").value||"").trim()){
      addOneEmailFromInput();
    }
  }
  if (state.mailList.length === 0){
    alert("Please add at least one email using the + button.");
    return;
  }

  var p = state.selectedEvent.extendedProps;
  var payload = {
    Training_Title: p.Training_Title || "",
    Training_Operator_Name: p.Training_Operator_Name || "",
    Training_Start: p.Training_Start,
    Training_End:   p.Training_End,
    Trainer_Name: p.Trainer_Name || "",
    Training_Topic: p.Training_Topic || "",
    Training_Machine: p.Training_Machine || "",
    Training_Status: p.Training_Status || "Planned"
  };

  busy(true); loading("Preparing email…");
  writeMailAttributes(payload, state.mailList.slice())
    .then(function(){
      loading("Email request sent ✓");
      mailOverlay.style.display = "none";
    })
    .catch(function(err){
      console.error(err);
      alert(err.message || "Failed to send mail request");
    })
    .finally(function(){ busy(false); });
});

/************ CREATE / UPDATE ************/
function openModalForDate(jsDate){
  state.mode = "create";
  state.clickedDate = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate());
  $("#modalTitle").textContent = "Add training session";
  $("#saveSession").textContent = "Save";
  $("#fDateHint").textContent = "Date: " + state.clickedDate.toDateString();
  $("#fTitle").value=""; $("#fTrainer").value=""; $("#fTopic").value=""; $("#fMachine").value="";
  $("#fTimeTo").value="09:00"; $("#fTimeFrom").value="11:00"; $("#fStatus").value="Planned";
  // reset operator chips
  state.opList = [];
  $("#fOperatorInput").value = "";
  refreshOpChips();
  overlay.style.display = "flex";
}

function onCreateSession(){
  var base = state.clickedDate || new Date();
  var payload = collectFormPayload(base);
  var must = requiredChecks(payload);
  if (must) { alert(must); return; }
  loading("Saving…"); busy(true);
  writeAttributes(payload, { mode:"create" })
    .then(function(){
      overlay.style.display="none";
      startAutoRefresh(payload.Training_Start);
    })
    .catch(function(e){ console.error(e); alert(e.message||"Failed to save"); })
    .finally(function(){ busy(false); });
}

function onUpdateSession(){
  if (!state.selectedEvent || !state.selectedEvent.extendedProps) {
    alert("No session selected for update."); return;
  }
  var base = state.clickedDate || new Date();
  var payload = collectFormPayload(base);

  var baseTs = state.selectedEvent.extendedProps.__ts;
  if (!baseTs) { alert("Missing base timestamp for update. Please reselect the event."); return; }
  payload.Update_Timestamp = baseTs;

  var must = requiredChecks(payload);
  if (must) { alert(must); return; }

  loading("Updating…"); busy(true);
  writeAttributes(payload, { mode:"update" })
    .then(function(){
      overlay.style.display="none";
      startAutoRefresh(payload.Update_Timestamp, function(found){
        var p = found.extendedProps || {};
        var titleOk = String(p.Training_Title||"") === String(payload.Training_Title||"");
        var statusOk = String(p.Training_Status||"") === String(payload.Training_Status||"");
        var startOk = Number(p.Training_Start||0) === Number(payload.Training_Start||0);
        var endOk   = Number(p.Training_End||0)   === Number(payload.Training_End||0);
        var opOk    = String(p.Training_Operator_Name||"") === String(payload.Training_Operator_Name||"");
        return titleOk && statusOk && startOk && endOk && opOk;
      });
    })
    .catch(function(e){ console.error(e); alert(e.message||"Failed to update"); })
    .finally(function(){ busy(false); });
}

function collectFormPayload(base){
  return {
    Training_Title: $("#fTitle").value.trim(),
    Training_Operator_Name: state.opList.join(", "), // <-- multi-operator as CSV
    Training_Start: mergeDateTime(base, $("#fTimeTo").value),
    Training_End:   mergeDateTime(base, $("#fTimeFrom").value),
    Trainer_Name: $("#fTrainer").value.trim(),
    Training_Topic: $("#fTopic").value.trim(),
    Training_Machine: $("#fMachine").value.trim(),
    Training_Status: $("#fStatus").value || "Planned"
  };
}

function requiredChecks(p){
  if (!p.Training_Title) return "Please enter Title";
  if (!state.opList.length && !($("#fOperatorInput").value||"").trim())
    return "Please add at least one Operator (use the + button)";
  if (!p.Trainer_Name) return "Please enter Trainer Name";
  if (!p.Training_Topic) return "Please enter Training Topic";
  if (!p.Training_Machine) return "Please enter Training Machine";
  if (p.Training_End <= p.Training_Start) return "Time From must be after Time To.";
  return "";
}

/************ BOOT ************/
function startCalendar(){
  if (!window.FullCalendar){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">FullCalendar failed to load.</span></div>';
    return;
  }
  if (!JWT){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">Missing JWT (?token=…)</span></div>';
    return;
  }
  var calEl = $("#calendar");
  state.calendar = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    headerToolbar: { left: "prev,next today", center: "title", right: "" },
    height: "auto",
    eventContent: eventContent,
    dateClick: function(info){ openModalForDate(info.date); },
    eventClick: function(info){ showDetails(info.event); },
    datesSet: function(info){
      loading("Loading…");
      state.lastRange = { start: info.start, end: info.end };
      readRangeSessions(info.start, info.end)
        .then(function(events){
          state.calendar.removeAllEvents();
          state.calendar.addEventSource(events);
          $("#details").className="empty"; $("#details").textContent="Select a session on the calendar";
          $("#sideActions").style.display="none";
          loading("Loaded "+events.length+" session(s)");
        })
        .catch(function(err){
          console.error(err);
          loading(err.message || "Failed to load");
          state.calendar.removeAllEvents();
        });
    }
  });
  state.calendar.render();
  loading("");
}
if (document.readyState === "complete" || document.readyState === "interactive") setTimeout(startCalendar,0);
else document.addEventListener("DOMContentLoaded", startCalendar);
</script>
</body>
</html>
