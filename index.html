<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PlantWiz • Training Calendar (Telemetry)</title>

<link id="fc-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--cyan:#06b6d4;--amber:#f59e0b;--red:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-columns:1fr 340px;gap:16px;min-height:100vh;padding:16px}
  header{grid-column:1/-1;display:flex;gap:10px;align-items:center;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
  .brand{font-weight:800}.spacer{flex:1}
  .btn,.input{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #calendar{min-height:560px}
  .side{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;position:sticky;top:16px;height:fit-content}
  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  footer{grid-column:1/-1;color:#64748b;font-size:12px;text-align:center}
  @media(max-width:1024px){.app{grid-template-columns:1fr}.side{position:static}}

  .fc .fc-toolbar{padding:10px}
  .fc .fc-toolbar-title{font-size:16px;font-weight:800}
  .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#0f172a;border-radius:10px;padding:6px 10px}
  .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
  .fc-daygrid-day-number{color:#64748b}

  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)} .status-live{background:var(--green)}
  .status-completed{background:var(--cyan)} .status-cancelled{background:var(--red)}
  .status-pending_approval{background:var(--amber)}
  .sub{display:block;font-weight:600;opacity:.95}
  .tiny{display:block;font-weight:600;opacity:.8;font-size:12px}
  .badge{display:inline-block;border-radius:999px;padding:3px 8px;font-size:12px;color:#fff}
  .b-planned{background:var(--blue)} .b-live{background:var(--green)}
  .b-completed{background:var(--cyan)} .b-cancelled{background:var(--red)}
  .b-pending_approval{background:var(--amber)}
  .muted{color:var(--muted)} #loading{font-size:12px;color:#64748b;margin-left:8px}
  .hint{font-size:12px;margin-left:8px;color:#64748b}
  .success{color:#16a34a}
  .err{color:#dc2626;font-weight:700}

  .overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(520px,92vw);background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:0 24px 48px rgba(0,0,0,.18)}
  .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
  .modal .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal .row-full{grid-column:1 / -1}
  .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}
  .danger{background:#fff;border:1px solid var(--red);color:#dc2626}
  .primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .well{border:1px dashed var(--ring);border-radius:8px;padding:8px;margin-top:8px;font-size:12px;color:#0f172a}
  .well code{font-weight:700}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">PlantWiz • Training Calendar</div>
    <span id="mode" class="hint"></span>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <div class="card"><div id="calendar"></div></div>

  <aside class="side">
    <h3 class="h6">Session details</h3>
    <div id="details" class="empty">Select a session on the calendar</div>

    <div class="well">
      <div><strong>Write method:</strong> <span id="writeHow">Device telemetry</span></div>
      <div style="margin-top:6px">
        <label for="tok">Device token (for writes)</label>
        <input id="tok" class="input" placeholder="Paste device access token">
        <button id="useTok" class="btn" style="margin-top:6px">Use token</button>
      </div>
      <div class="muted" style="margin-top:6px">Or add <code>?dtoken=YOUR_TOKEN</code> to the URL.</div>
    </div>
  </aside>

  <footer>
    Saves as <strong>telemetry</strong> at <code>ts=Training_Start</code> with values:
    Training_Title, Training_Operator_Name, Training_Start, Training_End, Trainer_Name, Training_Topic, Training_Machine, Training_Status
  </footer>
</div>

<!-- Create modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900">Add training session</div>
      <button class="btn danger" id="closeModal">Cancel</button>
    </header>
    <div class="body">
      <div class="row-full">
        <label>Title</label>
        <input id="fTitle" class="input" type="text" placeholder="e.g., Operational Safety">
      </div>
      <div>
        <label>Operator</label>
        <input id="fOperator" class="input" type="text" placeholder="Operator name">
      </div>
      <div>
        <label>Trainer Name</label>
        <input id="fTrainer" class="input" type="text" placeholder="Trainer name">
      </div>
      <div>
        <label>Time To</label>
        <input id="fTimeTo" class="input" type="time" value="09:00">
      </div>
      <div>
        <label>Time From</label>
        <input id="fTimeFrom" class="input" type="time" value="11:00">
      </div>
      <div class="row-full">
        <label>Training Topic</label>
        <input id="fTopic" class="input" type="text" placeholder="Short description">
      </div>
      <div class="row-full">
        <label>Training Machine</label>
        <input id="fMachine" class="input" type="text" placeholder="e.g., LATHE-02">
      </div>
      <div class="row-full muted" id="fDateHint">Date: —</div>
    </div>
    <footer>
      <button class="btn primary" id="saveSession">Save</button>
    </footer>
  </div>
</div>

<!-- FullCalendar JS + fallback -->
<script id="fc-js" src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
/* fallback to unpkg if primary fails */
window.addEventListener('error', function(e){
  var s = e.target || {};
  if (s.id === 'fc-js') {
    var alt = document.createElement('script');
    alt.src = 'https://unpkg.com/fullcalendar@6.1.11/index.global.min.js';
    document.body.appendChild(alt);
  }
}, true);

/************ CONFIG ************/
var ORIGIN    = "https://plantwiz.pimateck.in";
var API_BASE  = ORIGIN + "/api";
var DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
var JWT       = new URLSearchParams(location.search).get("token")  || "";
var DTOKEN    = new URLSearchParams(location.search).get("dtoken") || ""; // for WRITE
var KEYS = [
  "Training_Title","Training_Operator_Name","Training_Start","Training_End",
  "Trainer_Name","Training_Topic","Training_Machine","Training_Status"
];

/************ HELPERS ************/
function $(s){ return document.querySelector(s); }
function loading(t){ $("#loading").textContent = t || ""; }  /* <-- fixed single dot */
var state = { calendar:null, clickedDate:null, lastRange:null };

function mergeDateTime(baseDate, hhmm){
  var parts = String(hhmm||"00:00").split(":");
  var h = parseInt(parts[0]||"0",10), m = parseInt(parts[1]||"0",10);
  var d = new Date(baseDate); d.setHours(h||0, m||0, 0, 0);
  return d.getTime();
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>\"']/g, function(m){
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
  });
}
function colorByStatus(s){
  s = String(s||"planned").toLowerCase();
  if (s==="live") return "status-live";
  if (s==="completed") return "status-completed";
  if (s==="cancelled") return "status-cancelled";
  if (s==="pending_approval") return "status-pending_approval";
  return "status-planned";
}
function eventContent(arg){
  var p = arg.event.extendedProps;
  var time = arg.timeText || "";
  var machine = p.Training_Machine ? (" • " + escapeHtml(p.Training_Machine)) : "";
  var trainer = p.Trainer_Name ? (" – " + escapeHtml(p.Trainer_Name)) : "";
  var title = arg.event.title || "Training";
  return { html:
    '<span class="sub">'+time+machine+'</span>'+
    '<span>'+escapeHtml(title)+trainer+'</span>'+
    '<span class="tiny">'+escapeHtml(p.Training_Operator_Name || "")+'</span>'
  };
}

/************ TELEMETRY: READ ************/
function readRangeSessions(rangeStart, rangeEnd){
  if(!JWT){ return Promise.reject(new Error("Missing JWT (?token=) for reads")); }
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries"
          + "?keys=" + encodeURIComponent(KEYS.join(","))
          + "&startTs=" + rangeStart.getTime()
          + "&endTs="   + rangeEnd.getTime()
          + "&limit=5000";
  return fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } })
    .then(function(res){
      if(!res.ok) return res.text().then(function(t){ throw new Error("Timeseries read failed: "+t); });
      return res.json();
    })
    .then(function(tsObj){
      var map = {}; // ts -> row
      Object.keys(tsObj || {}).forEach(function(k){
        (tsObj[k]||[]).forEach(function(p){
          var ts = Number(p.ts);
          var rec = map[ts] || (map[ts] = { ts: ts });
          rec[k] = p.value;
        });
      });

      var out = [];
      Object.keys(map).forEach(function(tsStr){
        var r = map[tsStr];
        var st = Number(r.Training_Start || r.ts);
        var en = Number(r.Training_End || (st+30*60*1000));
        if (!st || !en) return;
        var title = String(r.Training_Title || r.Training_Topic || "Training");
        out.push({
          id: "ts-"+r.ts,
          title: title,
          start: new Date(st),
          end:   new Date(en),
          classNames: ["event", colorByStatus(r.Training_Status)],
          extendedProps: {
            Training_Title: title,
            Training_Oper_
